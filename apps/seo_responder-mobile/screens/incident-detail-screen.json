{
  "screenId": "scrIncidentDetail",
  "displayName": "Incident Detail",
  "description": "Comprehensive incident view showing incident info, hazard alerts, assigned units, ICS command structure, and navigation to notes and pre-plan. Read-heavy screen with tactical information.",
  "roleAccess": [],

  "onVisible": "UpdateContext({\n  locIncident: Coalesce(locSelectedIncident, gblActiveIncident),\n  locAssignments: Filter(seo_IncidentAssignment, _seo_incidentid_value = locIncident.seo_IncidentId),\n  locCommand: LookUp(seo_IncidentCommand, _seo_incidentid_value = locIncident.seo_IncidentId && IsBlank(seo_commandTerminatedOn)),\n  locHazards: Filter(seo_Hazard, _seo_incidentid_value = locIncident.seo_IncidentId)\n});",

  "dataSources": ["seo_Incident", "seo_IncidentAssignment", "seo_IncidentCommand", "seo_Hazard", "seo_Unit", "seo_Personnel"],

  "contextVariables": [
    {
      "name": "locIncident",
      "type": "Record (seo_Incident)",
      "purpose": "The incident being viewed — set from navigation context or gblActiveIncident"
    },
    {
      "name": "locAssignments",
      "type": "Table (seo_IncidentAssignment)",
      "purpose": "All unit/personnel assignments for this incident"
    },
    {
      "name": "locCommand",
      "type": "Record (seo_IncidentCommand)",
      "purpose": "Active (non-terminated) ICS command for this incident"
    },
    {
      "name": "locHazards",
      "type": "Table (seo_Hazard)",
      "purpose": "On-scene hazards linked to this incident"
    }
  ],

  "controls": [
    {
      "name": "cntDetailHeader",
      "controlType": "Container",
      "purpose": "Header with back button, incident number, priority color band",
      "properties": {
        "X": 0,
        "Y": 0,
        "Width": "Parent.Width",
        "Height": 70,
        "Fill": "Switch(locIncident.seo_priority, 'seo_IncidentPriority'.'Priority 1 — Immediate Life Threat', RGBA(220, 38, 38, 1), 'seo_IncidentPriority'.'Priority 2 — Urgent', RGBA(245, 158, 11, 1), 'seo_IncidentPriority'.'Priority 3 — Non-Urgent', RGBA(234, 179, 8, 1), RGBA(107, 114, 128, 1))"
      },
      "children": [
        {
          "name": "icoDetailBack",
          "controlType": "Icon",
          "purpose": "Back navigation",
          "properties": {
            "Icon": "ChevronLeft",
            "X": 8,
            "Y": 20,
            "Width": 32,
            "Height": 32,
            "Color": "RGBA(255, 255, 255, 1)",
            "OnSelect": "Navigate(scrHome, ScreenTransition.None)"
          }
        },
        {
          "name": "lblDetailIncidentNumber",
          "controlType": "Label",
          "purpose": "Incident number",
          "properties": {
            "X": 48,
            "Y": 12,
            "Width": "Parent.Width - 120",
            "Height": 28,
            "Text": "locIncident.seo_incidentNumber",
            "Size": 18,
            "FontWeight": "Bold",
            "Color": "RGBA(255, 255, 255, 1)"
          }
        },
        {
          "name": "lblDetailType",
          "controlType": "Label",
          "purpose": "Incident type",
          "properties": {
            "X": 48,
            "Y": 40,
            "Width": "Parent.Width - 120",
            "Height": 22,
            "Text": "Text(locIncident.seo_incidentType)",
            "Size": 13,
            "Color": "RGBA(255, 255, 255, 0.9)"
          }
        },
        {
          "name": "shpMCIBadgeDetail",
          "controlType": "Container",
          "purpose": "MCI badge in header",
          "properties": {
            "Visible": "locIncident.seo_isMCI",
            "X": "Parent.Width - 60",
            "Y": 16,
            "Width": 44,
            "Height": 22,
            "Fill": "RGBA(255, 255, 255, 0.3)",
            "BorderRadius": 4
          },
          "children": [
            {
              "name": "lblMCIDetail",
              "controlType": "Label",
              "purpose": "MCI text",
              "properties": {
                "Text": "\"MCI\"",
                "Size": 11,
                "FontWeight": "Bold",
                "Color": "RGBA(255, 255, 255, 1)",
                "Align": "Center",
                "Width": "Parent.Width",
                "Height": "Parent.Height"
              }
            }
          ]
        }
      ]
    },
    {
      "name": "cntHazardBanner",
      "controlType": "Container",
      "purpose": "Safety alert banner — prominent hazard warning when seo_hazardsOnScene is populated",
      "properties": {
        "X": 0,
        "Y": 70,
        "Width": "Parent.Width",
        "Height": "If(!IsBlank(locIncident.seo_hazardsOnScene), 50, 0)",
        "Visible": "!IsBlank(locIncident.seo_hazardsOnScene)",
        "Fill": "RGBA(220, 38, 38, 0.2)"
      },
      "children": [
        {
          "name": "icoHazardAlert",
          "controlType": "Icon",
          "purpose": "Warning icon",
          "properties": {
            "Icon": "Warning",
            "X": 12,
            "Y": 13,
            "Width": 24,
            "Height": 24,
            "Color": "RGBA(220, 38, 38, 1)"
          }
        },
        {
          "name": "lblHazardText",
          "controlType": "Label",
          "purpose": "Hazard description text",
          "properties": {
            "X": 44,
            "Y": 8,
            "Width": "Parent.Width - 56",
            "Height": 34,
            "Text": "locIncident.seo_hazardsOnScene",
            "Size": 12,
            "FontWeight": "Bold",
            "Color": "RGBA(220, 38, 38, 1)"
          }
        }
      ]
    },
    {
      "name": "cntDetailBody",
      "controlType": "VerticalContainer",
      "purpose": "Scrollable body with incident details sections",
      "properties": {
        "X": 0,
        "Y": "cntHazardBanner.Y + cntHazardBanner.Height",
        "Width": "Parent.Width",
        "Height": "Parent.Height - Self.Y - 70",
        "PaddingLeft": 16,
        "PaddingRight": 16,
        "PaddingTop": 12,
        "LayoutGap": 16,
        "VerticalOverflow": "Scroll"
      },
      "children": [
        {
          "name": "cntAddressSection",
          "controlType": "VerticalContainer",
          "purpose": "Address and location info",
          "properties": {
            "Width": "Parent.Width - 32",
            "LayoutGap": 4
          },
          "children": [
            {
              "name": "lblSectionAddress",
              "controlType": "Label",
              "purpose": "Section header",
              "properties": {
                "Text": "\"LOCATION\"",
                "Size": 11,
                "FontWeight": "Semibold",
                "Color": "RGBA(148, 163, 184, 1)"
              }
            },
            {
              "name": "lblAddress",
              "controlType": "Label",
              "purpose": "Full address",
              "properties": {
                "Text": "locIncident.seo_address & If(!IsBlank(locIncident.seo_apartment), \" Apt \" & locIncident.seo_apartment, \"\")",
                "Size": 16,
                "FontWeight": "Bold",
                "Color": "RGBA(255, 255, 255, 1)"
              }
            },
            {
              "name": "lblCrossStreet",
              "controlType": "Label",
              "purpose": "Cross street",
              "properties": {
                "Text": "If(!IsBlank(locIncident.seo_crossStreet), \"X/S: \" & locIncident.seo_crossStreet, \"\")",
                "Size": 13,
                "Color": "RGBA(148, 163, 184, 1)",
                "Visible": "!IsBlank(locIncident.seo_crossStreet)"
              }
            },
            {
              "name": "btnOpenMap",
              "controlType": "Button",
              "purpose": "Open in native device maps app",
              "properties": {
                "Text": "\"Open in Maps\"",
                "Width": 140,
                "Height": 36,
                "Fill": "RGBA(30, 41, 59, 1)",
                "Color": "RGBA(59, 130, 246, 1)",
                "Size": 12,
                "BorderRadius": 6,
                "OnSelect": "Launch(\"https://maps.apple.com/?q=\" & EncodeUrl(locIncident.seo_address))"
              }
            }
          ]
        },
        {
          "name": "cntTimestamps",
          "controlType": "VerticalContainer",
          "purpose": "Key incident timestamps",
          "properties": {
            "Width": "Parent.Width - 32",
            "LayoutGap": 4
          },
          "children": [
            {
              "name": "lblSectionTimestamps",
              "controlType": "Label",
              "purpose": "Section header",
              "properties": {
                "Text": "\"TIMESTAMPS\"",
                "Size": 11,
                "FontWeight": "Semibold",
                "Color": "RGBA(148, 163, 184, 1)"
              }
            },
            {
              "name": "lblDispatchedOn",
              "controlType": "Label",
              "purpose": "Dispatched timestamp",
              "properties": {
                "Text": "\"Dispatched: \" & If(!IsBlank(locIncident.seo_dispatchedOn), Text(locIncident.seo_dispatchedOn, \"HH:mm:ss\"), \"—\")",
                "Size": 13,
                "Color": "RGBA(203, 213, 225, 1)"
              }
            },
            {
              "name": "lblEnRouteOn",
              "controlType": "Label",
              "purpose": "First unit en route timestamp",
              "properties": {
                "Text": "\"1st En Route: \" & If(!IsBlank(locIncident.seo_firstUnitEnRouteOn), Text(locIncident.seo_firstUnitEnRouteOn, \"HH:mm:ss\"), \"—\")",
                "Size": 13,
                "Color": "RGBA(203, 213, 225, 1)"
              }
            },
            {
              "name": "lblOnSceneOn",
              "controlType": "Label",
              "purpose": "First unit on scene timestamp",
              "properties": {
                "Text": "\"1st On Scene: \" & If(!IsBlank(locIncident.seo_firstUnitOnSceneOn), Text(locIncident.seo_firstUnitOnSceneOn, \"HH:mm:ss\"), \"—\")",
                "Size": 13,
                "Color": "RGBA(203, 213, 225, 1)"
              }
            },
            {
              "name": "lblUnderControlOn",
              "controlType": "Label",
              "purpose": "Under control timestamp",
              "properties": {
                "Text": "\"Under Control: \" & If(!IsBlank(locIncident.seo_underControlOn), Text(locIncident.seo_underControlOn, \"HH:mm:ss\"), \"—\")",
                "Size": 13,
                "Color": "RGBA(203, 213, 225, 1)"
              }
            }
          ]
        },
        {
          "name": "cntAssignedUnits",
          "controlType": "VerticalContainer",
          "purpose": "Assigned units list",
          "properties": {
            "Width": "Parent.Width - 32",
            "LayoutGap": 4
          },
          "children": [
            {
              "name": "lblSectionUnits",
              "controlType": "Label",
              "purpose": "Section header with count",
              "properties": {
                "Text": "\"ASSIGNED UNITS (\" & CountRows(locAssignments) & \")\"",
                "Size": 11,
                "FontWeight": "Semibold",
                "Color": "RGBA(148, 163, 184, 1)"
              }
            },
            {
              "name": "galAssignedUnits",
              "controlType": "Gallery",
              "purpose": "Gallery of assigned units with status and role",
              "properties": {
                "Items": "locAssignments",
                "TemplateSize": 44,
                "TemplatePadding": 2,
                "Width": "Parent.Width",
                "Height": "Min(CountRows(locAssignments) * 48, 240)"
              },
              "children": [
                {
                  "name": "lblAssignmentName",
                  "controlType": "Label",
                  "purpose": "Unit name from assignment",
                  "properties": {
                    "Text": "ThisItem.seo_name",
                    "Size": 13,
                    "FontWeight": "Semibold",
                    "Color": "RGBA(255, 255, 255, 1)"
                  }
                },
                {
                  "name": "lblAssignmentRole",
                  "controlType": "Label",
                  "purpose": "ICS role if assigned",
                  "properties": {
                    "Text": "If(!IsBlank(ThisItem.seo_icsRole), Text(ThisItem.seo_icsRole), \"\")",
                    "Size": 11,
                    "Color": "RGBA(148, 163, 184, 1)"
                  }
                },
                {
                  "name": "shpMutualAidBadge",
                  "controlType": "Label",
                  "purpose": "Mutual aid indicator",
                  "properties": {
                    "Text": "\"MA\"",
                    "Visible": "ThisItem.seo_isMutualAid",
                    "Size": 10,
                    "Color": "RGBA(245, 158, 11, 1)",
                    "Align": "End"
                  }
                }
              ]
            }
          ]
        },
        {
          "name": "cntCommand",
          "controlType": "VerticalContainer",
          "purpose": "Active ICS command information",
          "properties": {
            "Width": "Parent.Width - 32",
            "Visible": "!IsBlank(locCommand)",
            "LayoutGap": 4
          },
          "children": [
            {
              "name": "lblSectionCommand",
              "controlType": "Label",
              "purpose": "Section header",
              "properties": {
                "Text": "\"ICS COMMAND\"",
                "Size": 11,
                "FontWeight": "Semibold",
                "Color": "RGBA(148, 163, 184, 1)"
              }
            },
            {
              "name": "lblCommandName",
              "controlType": "Label",
              "purpose": "Command name",
              "properties": {
                "Text": "locCommand.seo_commandName",
                "Size": 14,
                "FontWeight": "Bold",
                "Color": "RGBA(255, 255, 255, 1)"
              }
            },
            {
              "name": "lblCommandIC",
              "controlType": "Label",
              "purpose": "Incident Commander name",
              "properties": {
                "Text": "\"IC: \" & LookUp(seo_Personnel, seo_PersonnelId = locCommand._seo_incidentcommanderid_value).seo_fullName",
                "Size": 13,
                "Color": "RGBA(203, 213, 225, 1)"
              }
            },
            {
              "name": "lblCommandRadio",
              "controlType": "Label",
              "purpose": "Radio channel / talkgroup",
              "properties": {
                "Text": "If(!IsBlank(locCommand.seo_radioChannel), \"Radio: \" & locCommand.seo_radioChannel, \"\")",
                "Size": 13,
                "Color": "RGBA(203, 213, 225, 1)",
                "Visible": "!IsBlank(locCommand.seo_radioChannel)"
              }
            },
            {
              "name": "lblCommandStrategy",
              "controlType": "Label",
              "purpose": "Strategy mode (Offensive/Defensive/Transitional)",
              "properties": {
                "Text": "If(!IsBlank(locCommand.seo_strategyMode), \"Strategy: \" & Text(locCommand.seo_strategyMode), \"\")",
                "Size": 13,
                "FontWeight": "Bold",
                "Color": "Switch(locCommand.seo_strategyMode, \"Offensive\", RGBA(220, 38, 38, 1), \"Defensive\", RGBA(59, 130, 246, 1), \"Transitional\", RGBA(245, 158, 11, 1), RGBA(203, 213, 225, 1))",
                "Visible": "!IsBlank(locCommand.seo_strategyMode)"
              }
            }
          ]
        },
        {
          "name": "cntDetailActions",
          "controlType": "HorizontalContainer",
          "purpose": "Action buttons: Add Note, View Pre-Plan",
          "properties": {
            "Width": "Parent.Width - 32",
            "Height": 50,
            "LayoutGap": 12
          },
          "children": [
            {
              "name": "btnAddNote",
              "controlType": "Button",
              "purpose": "Navigate to Notes screen to add a note",
              "properties": {
                "Text": "\"Add Note\"",
                "Width": "(Parent.Width - 12) / 2",
                "Height": 44,
                "Fill": "RGBA(59, 130, 246, 1)",
                "Color": "RGBA(255, 255, 255, 1)",
                "Size": 14,
                "BorderRadius": 8,
                "OnSelect": "Navigate(scrNotes, ScreenTransition.None)"
              }
            },
            {
              "name": "btnViewPrePlan",
              "controlType": "Button",
              "purpose": "Navigate to Pre-Plan screen",
              "properties": {
                "Text": "\"Pre-Plan\"",
                "Width": "(Parent.Width - 12) / 2",
                "Height": 44,
                "Fill": "RGBA(30, 41, 59, 1)",
                "Color": "RGBA(255, 255, 255, 1)",
                "Size": 14,
                "BorderRadius": 8,
                "Visible": "!IsBlank(locIncident.seo_prePlanId)",
                "OnSelect": "Navigate(scrPrePlan, ScreenTransition.None)"
              }
            }
          ]
        },
        {
          "name": "cntOnSceneHazards",
          "controlType": "VerticalContainer",
          "purpose": "List of on-scene hazards with NFPA 704 data",
          "properties": {
            "Width": "Parent.Width - 32",
            "Visible": "CountRows(locHazards) > 0",
            "LayoutGap": 4
          },
          "children": [
            {
              "name": "lblSectionHazards",
              "controlType": "Label",
              "purpose": "Section header",
              "properties": {
                "Text": "\"ON-SCENE HAZARDS (\" & CountRows(locHazards) & \")\"",
                "Size": 11,
                "FontWeight": "Semibold",
                "Color": "RGBA(220, 38, 38, 1)"
              }
            },
            {
              "name": "galHazards",
              "controlType": "Gallery",
              "purpose": "Hazard list with type and NFPA 704 values",
              "properties": {
                "Items": "locHazards",
                "TemplateSize": 52,
                "TemplatePadding": 2,
                "Width": "Parent.Width",
                "Height": "Min(CountRows(locHazards) * 56, 200)"
              },
              "children": [
                {
                  "name": "lblHazardName",
                  "controlType": "Label",
                  "purpose": "Hazard name",
                  "properties": {
                    "Text": "ThisItem.seo_name",
                    "Size": 13,
                    "FontWeight": "Semibold",
                    "Color": "RGBA(220, 38, 38, 1)"
                  }
                },
                {
                  "name": "lblHazardType",
                  "controlType": "Label",
                  "purpose": "Hazard type",
                  "properties": {
                    "Text": "Text(ThisItem.seo_hazardType) & If(!IsBlank(ThisItem.seo_location), \" — \" & ThisItem.seo_location, \"\")",
                    "Size": 11,
                    "Color": "RGBA(203, 213, 225, 1)"
                  }
                },
                {
                  "name": "lblHazardNFPA",
                  "controlType": "Label",
                  "purpose": "NFPA 704 diamond values (H/F/R/S)",
                  "properties": {
                    "Text": "If(ThisItem.seo_nfpa704Health > 0 || ThisItem.seo_nfpa704Fire > 0 || ThisItem.seo_nfpa704Reactivity > 0, \"NFPA 704: H\" & ThisItem.seo_nfpa704Health & \" F\" & ThisItem.seo_nfpa704Fire & \" R\" & ThisItem.seo_nfpa704Reactivity & If(!IsBlank(ThisItem.seo_nfpa704Special), \" \" & ThisItem.seo_nfpa704Special, \"\"), \"\")",
                    "Size": 11,
                    "Color": "RGBA(245, 158, 11, 1)"
                  }
                }
              ]
            }
          ]
        },
        {
          "name": "lblNarrative",
          "controlType": "Label",
          "purpose": "Incident narrative summary (if populated)",
          "properties": {
            "Width": "Parent.Width - 32",
            "Text": "locIncident.seo_narrativeSummary",
            "Visible": "!IsBlank(locIncident.seo_narrativeSummary)",
            "Size": 13,
            "Color": "RGBA(203, 213, 225, 1)",
            "AutoHeight": true
          }
        }
      ]
    },
    {
      "name": "cmpNavBarDetail",
      "controlType": "Component",
      "purpose": "Bottom navigation bar",
      "properties": {
        "ActiveScreen": "\"scrIncidentDetail\"",
        "IsEMSProvider": "gblIsEMSProvider",
        "OnNavigate": "Navigate(LookUp([{id:\"scrHome\",scr:scrHome},{id:\"scrMap\",scr:scrMap},{id:\"scrNotes\",scr:scrNotes},{id:\"scrPatientTriage\",scr:scrPatientTriage},{id:\"scrSettings\",scr:scrSettings}], id = cmpNavBarDetail.SelectedScreen).scr, ScreenTransition.None)"
      }
    }
  ],

  "phiCompliance": {
    "accessesPHI": false,
    "justification": "Incident Detail screen shows incident metadata, assignments, command, and hazards. No PatientRecord columns are referenced. Patient count (seo_patientCount) is a non-PHI integer on seo_Incident."
  },

  "flowInteractions": [],

  "designerNotes": "1. Hazard banner is the first thing visible below the header — responder safety is top priority.\n2. Strategy mode is color-coded: Offensive (red = aggressive), Defensive (blue = defensive position), Transitional (orange = mixed).\n3. The screen accepts a navigation context variable (locSelectedIncident) allowing it to display any incident, not just the active one.\n4. Assigned units gallery caps at 240px height to prevent it from dominating the screen.\n5. Pre-Plan button only appears if the incident has a linked pre-plan.\n6. NFPA 704 values display as H/F/R/S shorthand (Health/Fire/Reactivity/Special).\n7. Mutual aid assignments show an 'MA' badge in orange."
}
