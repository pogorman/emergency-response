{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "seo-flow-definition-v1",
  "title": "EmergencyResponseCoordination Flow Definition",
  "description": "JSON Schema for Power Automate flow specification files. Each flow definition is a blueprint that describes the flow's trigger, steps, connections, and security context — intended to be translated into the Power Automate designer.",
  "type": "object",
  "required": [
    "flowId",
    "displayName",
    "description",
    "flowType",
    "status",
    "securityContext",
    "trigger",
    "steps",
    "connectionReferences",
    "environmentVariables",
    "errorHandling"
  ],
  "properties": {
    "flowId": {
      "type": "string",
      "pattern": "^seo_[A-Za-z]+$",
      "description": "Unique schema name for the flow, prefixed with seo_"
    },
    "displayName": {
      "type": "string",
      "description": "Human-readable name shown in the Power Automate portal"
    },
    "description": {
      "type": "string",
      "description": "Detailed description of what the flow does and why"
    },
    "flowType": {
      "type": "string",
      "enum": ["Automated", "Scheduled", "Instant"],
      "description": "Power Automate flow type"
    },
    "tier": {
      "type": "integer",
      "enum": [1, 2],
      "description": "Implementation priority tier"
    },
    "status": {
      "type": "string",
      "enum": ["Specification", "InDevelopment", "Testing", "Production"],
      "description": "Current lifecycle status of this flow definition"
    },
    "securityContext": {
      "type": "object",
      "required": ["runAs", "rationale"],
      "properties": {
        "runAs": {
          "type": "string",
          "enum": ["TriggeringUser", "FlowOwner"],
          "description": "TriggeringUser = stays within user's BU/role permissions. FlowOwner = runs as the service account (elevated privileges for BU/team management)."
        },
        "serviceAccountRole": {
          "type": "string",
          "description": "Required security role for the service account when runAs=FlowOwner"
        },
        "rationale": {
          "type": "string",
          "description": "Why this security context was chosen"
        }
      }
    },
    "trigger": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "DataverseRowCreated",
            "DataverseRowModified",
            "DataverseRowCreatedOrModified",
            "Schedule",
            "Manual"
          ],
          "description": "Power Automate trigger type"
        },
        "table": {
          "type": "string",
          "description": "Dataverse table schema name (for Dataverse triggers)"
        },
        "scope": {
          "type": "string",
          "enum": ["Organization", "BusinessUnit", "User"],
          "description": "Trigger scope — Organization for FlowOwner runs, BusinessUnit or User for TriggeringUser"
        },
        "filterColumns": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Columns that must change to fire the trigger. Critical for preventing circular triggers."
        },
        "filterExpression": {
          "type": "string",
          "description": "OData filter expression to limit which rows trigger the flow"
        },
        "schedule": {
          "type": "object",
          "properties": {
            "frequency": {
              "type": "string",
              "enum": ["Minute", "Hour", "Day", "Week", "Month"]
            },
            "interval": { "type": "integer" },
            "startTime": { "type": "string" },
            "timeZone": { "type": "string" }
          },
          "description": "Schedule configuration (for Schedule triggers only)"
        }
      }
    },
    "steps": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["stepNumber", "action", "description"],
        "properties": {
          "stepNumber": {
            "type": "integer",
            "description": "Execution order"
          },
          "action": {
            "type": "string",
            "description": "Power Automate action name (e.g., 'Create a new row', 'Update a row', 'Condition', 'Send an email')"
          },
          "description": {
            "type": "string",
            "description": "What this step does in plain language"
          },
          "connector": {
            "type": "string",
            "description": "Connection reference schema name used by this step"
          },
          "table": {
            "type": "string",
            "description": "Dataverse table targeted by this step"
          },
          "inputs": {
            "type": "object",
            "description": "Key-value pairs for step inputs. Values use Power Automate expression syntax where needed."
          },
          "condition": {
            "type": "object",
            "properties": {
              "expression": { "type": "string" },
              "ifTrue": {
                "type": "array",
                "items": { "$ref": "#/properties/steps/items" }
              },
              "ifFalse": {
                "type": "array",
                "items": { "$ref": "#/properties/steps/items" }
              }
            },
            "description": "Conditional branching (for Condition actions)"
          },
          "loop": {
            "type": "object",
            "properties": {
              "forEach": { "type": "string", "description": "Expression returning the array to iterate" },
              "steps": {
                "type": "array",
                "items": { "$ref": "#/properties/steps/items" }
              }
            },
            "description": "Apply to each loop configuration"
          },
          "runAfter": {
            "type": "array",
            "items": { "type": "integer" },
            "description": "Step numbers that must complete before this step runs. Enables parallel branches."
          },
          "notes": {
            "type": "string",
            "description": "Implementation notes or designer hints"
          }
        }
      }
    },
    "connectionReferences": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Schema names of connection references this flow uses (from solution/connection-references.json)"
    },
    "environmentVariables": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Schema names of environment variables this flow reads (from solution/environment-variables.json)"
    },
    "tables": {
      "type": "array",
      "items": { "type": "string" },
      "description": "All Dataverse tables this flow reads from or writes to"
    },
    "circularTriggerPrevention": {
      "type": "object",
      "properties": {
        "strategy": {
          "type": "string",
          "description": "How circular triggers are prevented"
        },
        "details": {
          "type": "string",
          "description": "Detailed explanation of the prevention mechanism"
        },
        "relatedFlows": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Other flow IDs that could potentially chain with this one"
        }
      },
      "description": "Documents how this flow avoids infinite trigger loops"
    },
    "errorHandling": {
      "type": "object",
      "required": ["strategy"],
      "properties": {
        "strategy": {
          "type": "string",
          "enum": ["TryCatch", "ConfigureRunAfter", "TerminateOnFailure"],
          "description": "Error handling pattern used"
        },
        "notifyOnFailure": {
          "type": "boolean",
          "description": "Whether to send email on flow failure"
        },
        "notificationTarget": {
          "type": "string",
          "description": "Environment variable for failure notification recipient"
        },
        "retryPolicy": {
          "type": "object",
          "properties": {
            "type": { "type": "string", "enum": ["none", "fixed", "exponential"] },
            "count": { "type": "integer" },
            "interval": { "type": "string" }
          }
        }
      }
    },
    "phiCompliance": {
      "type": "object",
      "properties": {
        "accessesPHI": {
          "type": "boolean",
          "description": "Whether this flow reads or writes PHI columns"
        },
        "justification": {
          "type": "string",
          "description": "If accessesPHI is true, why it's necessary. Should be 'N/A' if false."
        }
      },
      "description": "HIPAA compliance attestation for this flow"
    },
    "designerNotes": {
      "type": "string",
      "description": "Additional notes for the person building this flow in the Power Automate designer"
    }
  }
}
